---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import RegexLayout from '../../../components/regex/RegexLayout';
import { PatternService } from '../../../services/PatternService';
import type { Pattern } from '../../../types/pattern';
import builtInPatterns from '../../../data/built-in-patterns.json';

export async function getStaticPaths() {
  // Use built-in patterns for static generation
  const patterns = builtInPatterns as Pattern[];
  
  const routes = [];
  
  // Add routes for each pattern
  patterns.forEach(pattern => {
    // Standard pattern ID route (canonical)
    routes.push({
      params: { pattern_slug: pattern.id },
      props: { pattern, isCanonical: true }
    });
    
    // SEO-friendly slug route (if exists and different from ID)
    if (pattern.slug && pattern.slug !== pattern.id) {
      routes.push({
        params: { pattern_slug: pattern.slug },
        props: { pattern, isCanonical: false, canonicalId: pattern.id }
      });
    }
  });
  
  return routes;
}

// Generate SEO-optimized metadata
function generateSeoTitle(pattern: Pattern): string {
  const name = pattern.name.toLowerCase();
  
  // Create search-intent focused titles for common patterns
  if (name.includes('camel') && name.includes('kebab')) {
    return `Search and Replace CamelCase to kebab-case Online - Regex Tool | CodeTweak`;
  }
  if (name.includes('camel') && name.includes('snake')) {
    return `Search and Replace CamelCase to snake_case Online - Regex Tool | CodeTweak`;
  }
  if (name.includes('slash') && name.includes('dot')) {
    return `Search and Replace Slash with Dot Online - Regex Tool | CodeTweak`;
  }
  if (name.includes('dot') && name.includes('slash')) {
    return `Search and Replace Dot with Slash Online - Regex Tool | CodeTweak`;
  }
  
  // Default format for other patterns
  return `${pattern.name} - Online Regex Tool | CodeTweak`;
}

function generateSeoDescription(pattern: Pattern): string {
  const example = pattern.example;
  return `${pattern.description} Transform ${example.input} → ${example.output} with our free online regex find and replace tool.`;
}

const { pattern_slug } = Astro.params;
const { pattern, isCanonical, canonicalId } = Astro.props;

// If pattern is not passed as prop (in SSR mode), find it from the JSON
const actualPattern = pattern || builtInPatterns.find((p: Pattern) => p.id === pattern_slug || p.slug === pattern_slug) as Pattern;

if (!actualPattern) {
  throw new Error(`Pattern not found: ${pattern_slug}`);
}

// SEO metadata
const title = generateSeoTitle(actualPattern);
const description = generateSeoDescription(actualPattern);
const canonicalUrl = (isCanonical === false && canonicalId) ? `/tools/regex-find-replace/${canonicalId}` : undefined;
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <!-- JSON-LD Schema for SoftwareApplication -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": actualPattern.name,
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "description": actualPattern.description,
    "url": `https://codetweak.com/tools/regex-find-replace/${isCanonical !== false ? actualPattern.id : canonicalId}`,
    "creator": {
      "@type": "Organization",
      "name": "CodeTweak"
    }
  })} />

  <div class="max-w-7xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="flex mb-4 text-sm text-gray-500" aria-label="Breadcrumb">
      <div class="flex items-center space-x-2">
        <a href="/" class="hover:text-primary">Home</a>
        <span>›</span>
        <a href="/tools" class="hover:text-primary">Tools</a>
        <span>›</span>
        <a href="/tools/regex-find-replace" class="hover:text-primary">Regex Find Replace</a>
        <span>›</span>
        <span class="text-gray-900">{actualPattern.name}</span>
      </div>
    </nav>

    <header class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">{actualPattern.name}</h1>
      <p class="text-xl text-gray-600 mb-4">{actualPattern.description}</p>
      
      <!-- Example transformation -->
      <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border border-blue-200">
        <div class="text-sm text-gray-700 mb-2">
          <strong>Example transformation:</strong>
        </div>
        <div class="flex items-center space-x-3">
          <code class="bg-gray-100 px-3 py-2 rounded font-mono text-sm">{actualPattern.example.input}</code>
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
          <code class="bg-green-100 px-3 py-2 rounded font-mono text-sm text-green-800">{actualPattern.example.output}</code>
        </div>
      </div>

      <div class="flex items-center text-sm text-gray-500">
        <div class="flex items-center mr-4">
          <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md font-mono text-xs mr-1">⌘K</kbd>
          <span>to search patterns</span>
        </div>
        <div class="flex items-center">
          <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md font-mono text-xs mr-1">⌘↵</kbd>
          <span>to transform text</span>
        </div>
      </div>
    </header>

    <div class="mb-12">
      <RegexLayout client:load />
    </div>

    <section class="mb-12 border-t border-gray-200 pt-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Pattern Details</h2>
      <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Search Pattern</h3>
            <pre class="bg-gray-50 p-3 rounded-md font-mono text-sm overflow-x-auto">{actualPattern.searchRegex}</pre>
          </div>
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Replace Pattern</h3>
            <pre class="bg-gray-50 p-3 rounded-md font-mono text-sm overflow-x-auto">{actualPattern.replaceRegex}</pre>
          </div>
        </div>
        
        <div class="mt-6">
          <h3 class="text-lg font-medium text-gray-900 mb-2">Example</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-1">Input</h4>
              <pre class="bg-gray-50 p-3 rounded-md font-mono text-sm overflow-x-auto">{actualPattern.example.input}</pre>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-1">Output</h4>
              <pre class="bg-gray-50 p-3 rounded-md font-mono text-sm overflow-x-auto">{actualPattern.example.output}</pre>
            </div>
          </div>
        </div>
        
        {actualPattern.tags && actualPattern.tags.length > 0 && (
          <div class="mt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {actualPattern.tags.map((tag: string) => (
                <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">{tag}</span>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <section class="mb-12 border-t border-gray-200 pt-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">How to Use This Pattern</h2>
      <div class="prose max-w-none">
        <ol>
          <li>Enter your text in the input area above</li>
          <li>Click "Transform" or press ⌘+Enter to apply the transformation</li>
          <li>Copy the result from the output area</li>
        </ol>
        <p>
          You can also use the command palette (⌘K) to quickly switch between different patterns.
        </p>
      </div>
    </section>

    <section class="mb-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Related Patterns</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {builtInPatterns
          .filter((p: Pattern) => p.id !== pattern_slug && p.category === actualPattern.category)
          .slice(0, 3)
          .map((p: Pattern) => (
            <a href={`/tools/regex-find-replace/${p.slug || p.id}`} class="block p-4 bg-white rounded-lg border border-gray-200 hover:border-primary hover:shadow-md transition-all">
              <h3 class="font-medium text-gray-900">{p.name}</h3>
              <p class="text-sm text-gray-500 mt-1">{p.description}</p>
            </a>
          ))
        }
      </div>
    </section>
  </div>
</BaseLayout>

<script define:vars={{ patternId: actualPattern.id }}>
  // Initialize the pattern store and select the current pattern
  document.addEventListener('DOMContentLoaded', async () => {
    // Dynamically import the store functions
    const { initializePatternStore, selectPattern } = await import('/src/stores/patternStore.ts');
    
    // Initialize the pattern store first
    await initializePatternStore();
    
    // Then select our specific pattern (this will override any localStorage selection)
    selectPattern(patternId);
  });
</script>